syntax = "proto3";

package trading.market_data;

import "proto/v1/common/types.proto";

option go_package = "github.com/Marwan051/tradding_platform_game/proto/gen/go/v1/market_data";

// MarketDataService provides info about the market status
service MarketDataService {
  // Get order book for a certain stock
  rpc GetOrderBook(GetOrderBookRequest) returns (OrderBook);
  // Stream live order book entries for a certain stock
  rpc StreamOrderBook(StreamOrderBookRequest) returns (stream OrderBookUpdate);

  // Get latest trades on a stock since a certain timestamp
  rpc GetRecentTrades(GetRecentTradesRequest) returns (GetRecentTradesResponse);
  // Stream live updates for a stock
  rpc StreamTrades(StreamTradesRequest) returns (stream TradeUpdate);

  // Get prices for stock(s)
  rpc GetStockPrices(GetStockPricesRequest) returns (GetStockPricesResponse);
  // Stream latest prices for stock(s) 
  rpc StreamPrices(StreamPricesRequest) returns (stream PriceUpdate);

  // Get an order details
  rpc GetOrder(GetOrderRequest) returns (common.types.Order);
  // Get all orders for a certain user
  rpc GetUserOrders(GetUserOrdersRequest) returns (GetUserOrdersResponse);
  // Stream all orders for a certain user
  rpc StreamUserOrders(StreamUserOrdersRequest) returns (stream OrderUpdate);

  // Get stats about the matching engine and its stocks
  rpc GetMarketStats(GetMarketStatsRequest) returns (MarketStats);
}



// GetOrderBookRequest request for fetching snapshot of order book.
message GetOrderBookRequest {
  string stock_ticker = 1;
  int32 depth = 2;
}

// OrderBook represents a snapshot of the current state of the order book for a given stock.
message OrderBook {
  string stock_ticker = 1;
  repeated PriceLevel bids = 2;
  repeated PriceLevel asks = 3;
  int64 timestamp_ms = 4;
  int64 last_trade_price_cents = 5;
  int64 spread_cents = 6;
}

// PriceLevel represents a specific price point in the order book with aggregated quantity.
message PriceLevel {
  int64 price_cents = 1;
  int64 quantity = 2;
  int32 order_count = 3;
}

// StreamOrderBookRequest request to subscribe to real-time updates for an order book.
message StreamOrderBookRequest {
  string stock_ticker = 1;
  int32 depth = 2;
}

// OrderBookUpdate represents an incremental update to the order book state.
message OrderBookUpdate {
  string stock_ticker = 1;
  int64 timestamp_ms = 2;
  repeated PriceLevelDelta bid_deltas = 3;
  repeated PriceLevelDelta ask_deltas = 4;
  int64 last_trade_price_cents = 5;
  int64 spread_cents = 6;
}

// PriceLevelDelta represents a change at a specific price level.
message PriceLevelDelta {
  int64 price_cents = 1;
  int64 new_quantity = 2;
  DeltaType delta_type = 3;
}

// DeltaType defines the type of change applied to a price level.
enum DeltaType {
  DELTA_ADD = 0;
  DELTA_UPDATE = 1;
  DELTA_REMOVE = 2;
}


// GetRecentTradesRequest request to fetch historical trades for a stock.
message GetRecentTradesRequest {
  string stock_ticker = 1;
  int32 limit = 2;
  int64 since_timestamp_ms = 3;
}

// GetRecentTradesResponse response containing a list of recent trades.
message GetRecentTradesResponse {
  repeated PublicTrade trades = 1;
}

// PublicTrade represents a trade that has occurred in the public market.
message PublicTrade {
  string trade_id = 1;
  string stock_ticker = 2;
  int64 quantity = 3;
  int64 price_cents = 4;
  int64 total_value_cents = 5;
  int64 timestamp_ms = 6;
  bool was_buyer_aggressor = 7;
}

// StreamTradesRequest request to subscribe to real-time trade execution updates.
message StreamTradesRequest {
  string stock_ticker = 1;
}

// TradeUpdate represents a real-time update of a newly executed trade.
message TradeUpdate {
  string trade_id = 1;
  string stock_ticker = 2;
  int64 quantity = 3;
  int64 price_cents = 4;
  int64 total_value_cents = 5;
  int64 timestamp_ms = 6;
  bool was_buyer_aggressor = 7;
}

// GetStockPricesRequest request to fetch current prices for multiple stocks.
message GetStockPricesRequest {
  repeated string stock_tickers = 1;
}

// GetStockPricesResponse response containing current prices for requested stocks.
message GetStockPricesResponse {
  repeated common.types.StockPrice prices = 1;
}

// StreamPricesRequest request to subscribe to real-time price updates for stocks.
message StreamPricesRequest {
  repeated string stock_tickers = 1;
}

// PriceUpdate represents a real-time update in a stock's price info.
message PriceUpdate {
  string stock_ticker = 1;
  string ticker = 2;
  int64 new_price_cents = 3;
  int64 change_cents = 4;
  int32 change_percent_basis_points = 5;
  int64 timestamp_ms = 6;
  string caused_by_trade_id = 7;
}

// GetOrderRequest request to fetch details of a specific order.
message GetOrderRequest {
  string order_id = 1;
}

// GetUserOrdersRequest request to fetch orders belonging to a specific user or bot.
message GetUserOrdersRequest {
  string user_id = 1;
  string bot_id = 2;
  repeated common.types.OrderStatus status_filter = 3;
  string stock_ticker = 4;
  int32 limit = 5;
  int64 offset = 6;
}

// GetUserOrdersResponse response containing a list of user orders.
message GetUserOrdersResponse {
  repeated common.types.Order orders = 1;
  int32 total_count = 2;
}

// StreamUserOrdersRequest request to subscribe to real-time order updates for a user.
message StreamUserOrdersRequest {
  string user_id = 1;
  string bot_id = 2;
}

// OrderUpdate represents a real-time update to a specific order's status or fill state.
message OrderUpdate {
  string order_id = 1;
  common.types.OrderStatus old_status = 2;
  common.types.OrderStatus new_status = 3;
  int64 filled_quantity = 4;
  int64 remaining_quantity = 5;
  int64 fill_price_cents = 6;
  int64 timestamp_ms = 7;
  bool is_final = 8;
}

// GetMarketStatsRequest request to fetch global market statistics.
message GetMarketStatsRequest {}

// MarketStats represents aggregated statistics for the entire market.
message MarketStats {
  int64 total_trades_today = 1;
  int64 total_volume_cents_today = 2;
  int32 active_orders_count = 3;
  repeated StockStats stock_stats = 4;
  int64 timestamp_ms = 5;
}

// StockStats represents aggregated statistics for a single stock.
message StockStats {
  string stock_ticker = 1;
  string ticker = 2;
  int64 trades_today = 3;
  int64 volume_today = 4;
  int32 active_orders = 5;
  int64 current_price_cents = 6;
}